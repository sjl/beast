(in-package :beast)


;;;; Notes
;;; Entities are stored in an {id -> entity} hash table.
;;;
;;; Entities are also indexed by aspect in a nested hash table:
;;;
;;;     {aspect-symbol -> {id -> entity}}
;;;
;;; Entities are indexed by system too, as a vector of hash tables, one entry
;;; for each of the system's arguments:
;;;
;;;     {system-symbol ->
;;;        #({id -> entity}   ; arg1
;;;          {id -> entity})  ; arg2
;;;     }
;;;
;;; Systems are stored as:
;;;
;;;     {system-symbol -> (system-function arity type-specifier-list)}
;;;
;;; TODO: Figure out the distinct problem.


;;;; Global Data Structures ---------------------------------------------------
(defvar *entity-id-counter* 0)
(defvar *entity-index* (make-hash-table))
(defvar *aspect-index* (make-hash-table))
(defvar *system-index* (make-hash-table))
(defvar *systems* (make-hash-table))


;;;; Utils --------------------------------------------------------------------
(defun symb (&rest args)
  (values (intern (format nil "窿狎珞┅┅换换蓬糸糸弩ㄤ彐沆狍孱糸豉īè殇候遽溴孱糸豉殇洪铋翩矧ㄩ钽孱糸豉殇泔躅翦颡轰镢蹴孱翎糸镱⒃桢躅轳蹂赡镦翳孱糸豉澡轶磲顼狩狴轭翳骢趱蝈ē忮狍舣狍疱泗横祆镢狒轱恒灬篌洪铋翩矧铋轰镢蹴孱翎糸镱⒘扉篝镦翳狍疱泗翳轶孱糸豉沆狍轭桢蜷趔娘瞌麸蹉翳轶┅ê滹沲礤铘狒轱⒘箝铉戾孱糸豉轭翳玑礤黠蜢洚┅ㄤ彐礤翳镤痱轭舡镡赍泗è孱糸豉篝蝈犴痱轭舡躅蝈徜徕戾镡赍泗ㄥ篝蝈犴呼疱洪溴铘轸铋飑ㄦ矧磲篝蝈犴蘑ㄥ铘轸殇濠┅ㄤ彐躅孱糸豉筢糸箧殄蟓簌篝屙豉疱箴邈殒殄颦ㄥ铘轸箴邈殒殄颟ㄥ鲥蝙灬礅溽ㄡ箴邈舂豉疱孱糸豉狍疱泗┅箴邈殒殄颟ㄤ彐躅轭溴孱糸豉ㄥ铘轸⑸铙弪噱铘轸轭麸翳孱糸豉轭溴箦翩ㄧ弭栳箬ㄥ铘轸殇孱糸豉孱糸豉轭溴孱糸豉┅ㄤ彐躅轭溴孱糸豉狍疱泗ㄥ铘轸⑸铙弪噱铘轸轭麸狃痱镳蜷狒狍疱泗轭溴弩祜镳烘矧狍疱泗洪箪雉鲠祯孱糸豉Д忮狍舣狍疱泗螬轰箦翩ㄧ弭栳箬ㄥ铘轸殇孱糸豉ㄧ弭栳箬狍疱泗狍疱泗轭溴┅孱糸豉┅ㄤ彐躅轭溴孱糸豉簌篝屙ㄥ铘轸⑸铙弪噱铘轸轭麸狃痱镳蜷狒簌篝屙轭溴弩祜镳瑚轸殇ㄥ铘轸殇孱糸豉烘矧簌篝屙衡彘铉呼桢栳箬脲猴簌篝屙螵乎箝铉ㄨ狍璀鲠祯铋铋豉疱箴邈殒殄蝮┅轰祜镳烘矧狎珲礤铘轭溴横泸矬ㄧ弭栳箬簌篝屙簌篝屙轭溴烘矧箴邈殒殄洪豉疱箴邈殒殄蝮瑚桢ㄥ铘轸筢糸箧殄蟓簌篝屙豉疱箴邈殒殄颦孱糸豉箴邈殒殄颟轰箦翩ㄧ弭栳箬殇狎珲礤铘轭溴孱糸豉┅┅ㄤ彐躅躅轭溴孱糸豉ㄩ洎⒁屙秭噱铘轸骝镯翳孱糸豉戾鲥轭溴蝈龛狍殇孱糸豉轭溴┅ㄤ彐躅躅轭溴孱糸豉狍疱泗ㄩ洎⒁屙秭噱铘轸骝镯翳狍疱泗轭溴弩祜镳烘矧轭溴衡彘铉呼桢鸿狍璀鲠祯弩猴狍疱泗轭溴轰蝈龛狍殇轭溴┅ㄤ彐躅躅轭溴孱糸豉簌篝屙ㄩ洎⒁屙秭噱铘轸骝镯翳簌篝屙轭溴弩祜镳烘矧狎珲礤铘轭溴弩衡彘铉呼桢栳箬鲠祯弩猴簌篝屙轭溴轰祜镳烘矧轭溴横泸矬狎珲礤铘轭溴弩轰蝈龛狍殇轭溴┅┅ㄤ彐珏铄蜷孱糸豉泸遽翦ㄥ铘轸ê礤翳镤è孱糸豉孱糸豉┅铋飑ê滹沲礤铘狒轱⒚犰戾徭翦犷孱糸豉栳忮孱泸遽翦犷轭溴邃澡溴驷蹯礤翳镤滹弩铒翳轭绗怩躞弪汜轫痨屙孱翳彘秣狨殪灬蝙礤翳镤麸蝓泔溴麒孱孱糸糸弩狎泸遽翦洚┅ㄤ彐珏铄蜷孱糸豉溴篝蝻邃ㄥ铘轸ê礤翳镤è孱糸豉孱糸豉┅铋飑ê滹沲礤铘狒轱⒚犰戾徭翦犷孱糸豉栳忮孱溴篝蝻邃犷躅轭溴邃澡溴驷蹯礤翳镤滹弩铒翳轭绗怩躞弪汜轫痨屙孱翳彘秣狨殪灬蝙礤翳镤麸蝓泔溴麒孱孱糸糸弩狎溴篝蝻邃┅ㄤ彐躅泸遽翦孱糸豉ㄣ灬篌蝈篝轭轸狎珞⒚蝈狒犷孱糸豉镦翳玳鲥孱糸豉沆狍犷蝈趱蝾轸嚅铋翎蜱筻鏖祆忮疳篌邃犰镱麸囗犭瀛轭篝犷沐喈澡噱铘轸泸遽翦溧珏铄蜷骢钽糸镱鏖祆忮汜祆邃牾篝忮骘蝈蝈趱蝾轭翳孱糸豉戾è孱糸豉ㄡ痧禊＇磲脲轭篝犷沐沆狍轭轸狎珞┅ㄩ钿屮孱糸豉孱糸豉ㄩ钿屮孱糸豉狍疱泗孱糸豉ㄩ钿屮孱糸豉簌篝屙孱糸豉ㄥ铘轸泸遽翦孱糸豉孱糸豉┅ㄤ彐躅溴篝蝻孱糸豉ㄥ铘轸⒛弩趄稆噱铘轸犷蝈趱蝾轸澡噱铘轸溴篝蝻邃珏铄蜷骢钽糸镱鏖祆忮汜祆邃徭翦翳孱糸豉栳忮孱溴篝蝻邃犷躅轭溴邃戾è殇ㄥ铘轸殇孱糸豉┅躅轭溴孱糸豉殇躅轭溴孱糸豉狍疱泗殇躅轭溴孱糸豉簌篝屙殇┅ㄥ铘轸溴篝蝻邃孱糸豉孱糸豉ㄤ彐躅沆遽颦孱糸糸弩ī⒛弩趄稆犰孱糸糸弩噤弩趄稆孱糸豉鏖祆忮汜祆邃骘遽汨孱糸豉义趱蝾扉篝镦犰翳溴篝蝻邃孱糸翦螽戾è孱糸糸弩ㄡ祆孱糸糸弩┅磲疸＇溴篝蝻孱糸豉孱糸糸弩孱糸糸弩┅ㄤ彐躅珏舡孱糸豉ㄩ洎⒁弭躜翳孱糸豉鏖翳翳玳鲥嚅溧矧囝殪殒轸轶躅腩秣町ㄧ弭栳箬殇孱糸豉轭溴┅ㄤ彐躅犰飙孱糸糸弩ī⒁弭躜扉篝镦犰孱糸糸弩物蝽犰禊秕箬秕熹蝓泔溴镱孱糸糸弩躞轭簌篝屙蟋怩翳轶骢钽糸镱汜忮栳钿骘溴怩珑轭瘐蝠矬弩祜镳烘矧孱糸豉衡彘铉呼桢鸿狍璀鲠祯弩猴孱糸豉轭溴恒镬戾泗孱糸豉┅ㄤ彐躅磲瓠孱糸糸弩ㄦ躅泗轱镳糸镱犰豉疱у铘轸┅⑼狃噫躅泗轱钹秭弪犰孱糸糸弩翳狒狎篚怍疱镦圄疱喈物蝽犰禊秕箬秕熹蝓泔溴镱孱糸糸弩躞轭簌篝屙蟋怩翳轶骢钽糸镱汜忮栳钿骘溴怩珑轭瘐蝠矬弩祜镳烘矧孱糸豉衡彘铉呼桢鸿狍璀鲠祯弩猴孱糸豉轭溴瑚桢豉疱孱糸豉豉疱恒镬戾泗ㄦ躅汜祆骢钽糸镱孱糸豉┅ㄤ彐磲泸溴骈铄孱糸豉钺礤狍疱泗蝈篝箪雉螬⒛彐轭犷孱糸豉沆狍螽囝犴遴箬秕熹忮簌礅镬翳狒鏖祆忮泔礤翳钺礤镦翳沆狍螽噌箴邈趔箬秕熹忮扉篝镦翳狍疱泗翳轶孱糸豉箬秕熹轭桢蜷骝镯囿祜趔汜忮弪矧盹蝈屮趄锰嫌箪雉溴骈铋糸镱螽砒犴痨弩ㄤ彐轭瀛孱糸豉痫糸镱ㄤ蜷铍徕戾┅ㄤ彐轭瀛孱糸豉汨邋箦ㄥ溟忪鲩箝忪濠ㄦ灬鲲横沣弩箫汨邋箦骒狯矧洪铋翎蜱烘灬鲲颟啜痱镧ㄤ彐沆狍钺礤ㄥ铘轸泪箴邈趔èモ遽篝狍疱泗横祆镢狒轱恒灬篌洪铋翩矧К狍疱泗螬荔祜趔┅ㄤ彐躅簌礅钺礤Э镡赍泗豉疱镡赍泗К钺礤┅ㄦ轭洵沆狍К钺礤┅换换馏疱泗ㄤ彐躅轭轸獒扉瀛狍疱泗轭溴钺礤麒孱铒ㄧ弭栳箬钺礤狍疱泗轭溴┅箦翩ㄧ弭栳箬钺礤狍疱泗轭溴磲脲栳箬翎忪濠┅ㄤ彐磲泸溴骈铄狍疱泗钺礤蝈篝骈屐潴⒛彐轭犷狍疱泗沆狍螽囝犴遴箬秕熹忮簌礅镬翳狒鏖祆忮泔礤翳钺礤镦翳沆狍螽噫殄熹筻箬秕熹忮弪矧盹蝈骈屐溴骈铋糸镱螽裴汨骈屐溴骈铋糸镱汜忮簌礅镬翳骈屐钺礤┈矧扉篝镦翳骈屐钺礤犷屮趄锰嫌箪雉镳糸镱螽崎屐钺礤鏖祆栳鲥翳狍疱泗钺礤犷箪狍痱屦孱溴麸翳屙麸泸遽翦翳箪雉钺礤螽嗪轭轸狎玎犷嗪徙沐篌矧箪雉镳糸镱鏖祆犰箫忮狨麸磲糸汜祆珏铄蜥翦洚砒犴痨搴ㄤ彐轭瀛狍疱泗邃殁戾孱弪琦翎篝洪铋翩矧铋飑骄ㄤ彐沆狍邃殁戾īè邃殁戾孱弪琦洪铋翎蜱哄溟忪瀵孱弪琦横沣弩箫邃殁戾孱弪琦ㄥ溟忪瀵翎篝洪铋翎蜱哄溟忪瀵翎篝横沣弩箫邃殁戾翎篝洪铋翩矧铋飑┅ㄦ戾è沆遽瞽骈屐ㄦㄣ豉疱汜箦簌礅镬扉篝姗扉篝姗┅啜痱镧ㄤ彐沆狍钺礤ī祜镳烘矧ㄦ殄熹骈屐洵镳糸镱螬洪磲疸狎＇沆遽瞽骈屐骈屐潴烘矧骈屐洵钺礤簌礅钺礤Н骈屐洎恒镬戾泗啜骈屐洵钺礤横沣弩箫骈屐洵钺礤洪铋翎蜱ㄩ铘弪篝蜷铉骈屐洵钺礤弘妁黠蜾梨殄熹镳糸镱螬┅ㄤ彐躅簌礅钺礤Э镡赍泗豉疱镡赍泗К钺礤┅ㄩ铋糸犰辁瀛狍疱泗轭溴К钺礤ㄦ轭洵沆狍К钺礤┅┅换换御篝屙ㄤ彐躅蝈怩殪洵簌篝屙轭溴ㄡ蜱扉篝ㄣ镥蜚祜镳烘矧铋豉疱箴邈殒殄颟洪狎珈轶烘矧轭溴磲脲栳箬翎忪濠轰祜镳烘矧孱糸豉衡彘铉呼桢鸿狍璀鲠祯弩猴孱糸豉轭溴瑚桢ㄥ铘轸筢糸箧殄蟓簌篝屙豉疱箴邈殒殄颦孱糸豉豉疱箴邈殒殄颟轰箦翩ㄧ弭栳箬ㄥ铘轸殇孱糸豉轭溴孱糸豉┅恒镬戾泗轭溴鲥泗矧┅ㄤ彐躅轭轸獒扉瀛簌篝屙轭溴钺礤骢钽糸镱狎珈轶舂箦翩ㄧ弭栳箬钺礤簌篝屙螵扉篝骢钽糸镱戾铉翳狎珈轶舂磲疸狎＇沅狎珈轶舂ㄧ弭栳箬钺礤簌篝屙轭溴蝈怩殪洵簌篝屙轭溴狎珈轶舂┅ㄤ彐躅怩殪洵簌篝屙蝓铑弪钺礤豉疱箴邈殒殄蝮躅戾篌铛祆豉疱箴邈殒殄蝮戾è狎珲礤铘轭溴弩ㄧ孱簌⒘散┅ㄡ蜱蹴孱趔祜镳候屦遽戾铉翳豉疱箴邈殒殄蝮恒镬戾泗ㄧ孱簌⑴┅┅啜戾è狎珲礤铘轭溴弩ㄧ弭栳箬К钺礤簌篝屙轭溴┅灬忮祗è蝈沲豉疱狎珞瞟ㄩ铛祆豉疱螬啜钺礤泪蜱蹴孱趔啜祜镳烘矧ㄦ轵篝狎珞猴姝豉疱ㄦ轵篝豉疱螬衡彘铉呼桢鸿狍璀鲠祯弩猴ㄡ蝈狎珲礤铘轭溴弩瞟轰蝈沲蝈篝豉疱螬蝈篝狎珞ū瞟┅┅蝈沲豉疱箴邈殒殄蝮狎珲礤铘癌┅┅ㄤ彐磲泸溴骈铄簌篝屙钺礤犷洵镳糸镱狎珈轶怙澌怙澌⒛彐轭簌篝屙囝犴瀛犷洵镳糸镱筻箬秕熹忮扉篝镦翳簌篝屙钺礤ㄡ簌礅镬犷犷簌篝屙镳糸镱螽忉蝈簌礅镬汜忮躞邃殒铒镳糸镱狎铄邃邃噌蜱扉篝箬秕熹忮扉篝镦簌篝屙狎珲礤铘螽裴汨狎珲礤铘箬秕熹忮扉篝镦翳狎珲礤铘钺礤犷弪矧盹蝈狍疱泗孱糸豉沆狍箦螽腻骈铋铉簌篝屙噫镲溴骈铄赭骢钽糸镱蠛噫镲蝓铙噔镤镱箝铉戾孱糸豉犷箬秕熹镱禊忮躞邃骘溴怩珑轭绗趄徙轭绗矧溟筢篌屙忪轭绠囹躅骘镟箬秕熹忮汜祆邃麸蝓翳簌篝屙镱犰狃痨殂徕戾孱糸糸弩瘤衢灬忪簌篝屙镳糸镱蠛嗪轭扉铄嗪麒孱趄蹂趄麸轭扉铄翳簌篝屙骢钽糸镱轭麸翳簌篝屙蝓铑轭骢钽糸镱麸狯镩翳秭弪桢徜镦骢钽糸镱汜祆骘弼弪孱糸豉腻驷蹯趔麸囝殪喈砒犴痨弩ㄤ彐轭瀛簌篝屙徵è孱糸豉扉驽糸礤┅麒孱ㄩ钽扉驽糸礤徵孱糸豉┅扉驽糸礤扉驽箴犷孱糸豉┅ㄤ弩趄稆孱糸豉孱糸豉┅戾è狎珲礤铘豉疱箴邈殒殄蝮祜镳烘矧狎洪狎珈轶彘翳弪骘矧ㄦ镲岜岵烘矧沆狍箦ㄩ扉篝狎绌蝈篝狎绌铋飑恒镬戾泗啜犷孱糸豉楞灬篌弩┅┅ㄤ弩趄蹉趱蜷铉忾钿钺礤脲轭扉铄ㄩ扉篝钺礤犷洵镳糸镱螬钺礤犷洵镳糸镱扉篝钺礤犷洵镳糸镱螬啜痱镧ㄤ邈灬轫ㄦ豉疱ㄦ躅泗轱ì泪蜱蹴孱舡豉疱箴邈殒殄蝮鲠祯弩铛祆镳糸镱犰┅钺礤ㄩ轭扉铄啜轭扉铄钺礤啜铒糸铎轭钺礤┅ㄤ彐躅钺礤ì括磲疸狎＇汜狎珈轶舂棱镤铋飑ㄤ彐躅簌礅蝓瞽钺礤īㄢ蹰熹簌篝屙蝓铑弪钺礤狎珲礤铘豉疱箴邈殒殄蝮┅ㄩ铋糸犰辁瀛簌篝屙轭溴К钺礤＇钺礤К狎珈轶舂К钺礤┅┅